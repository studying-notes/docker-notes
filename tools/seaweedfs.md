---
date: 2022-06-26T21:35:53+08:00
author: "Rustle Karl"

title: "Seaweedfs 分布式文件系统"
url:  "posts/docker/tools/seaweedfs"  # 永久链接
tags: [ "Docker", "README" ]  # 标签
categories: [ "Docker 学习笔记" ]  # 分类

toc: true  # 目录
draft: true  # 草稿
---

## 简介

随着业务量增长，一个系统需要存储上百万文件的情况越来越多，尤其是互联网网站。

在这种情况下依然使用传统磁盘/共享存储的方式进行支持会有以下问题：

* 文件的备份、恢复困难，大量文件的 copy 耗时耗力
* 文件数量暴增占满操作系统文件系统 inode，导致磁盘空间虽然没有用完但是因为 inode 用尽无法使用
* 文件读取效率太低，无法应对高并发读取要求

针对以上问题，facebook 提出了自己的方案 Facebook’s Haystack design paper。 

之后各种实现出现，如 tfs、MogileFS、GlusterFS 等，其中 Seaweedfs 是一个比较优秀的实现。具有效率高、结构简单、代码清晰等优点。

weed-fs 起初是为了搞一个基于 Fackbook 的 Haystack 论文的实现，Haystack 旨在优化 Fackbook 内部图片存储和获取。

## 架构

通常，分布式文件系统将每个文件拆分为块，中央主服务器保持文件名，到块句柄的块索引以及每个块服务器具有的块。

主要缺点是中央主服务器无法高效地处理许多小文件，并且由于所有读请求都需要通过块主服务器，所以对于许多并发用户来说可能无法很好地扩展。

SeaweedFS 管理主服务器中的数据卷，而不是管理块。每个数据卷大小为 32GB，并且可以容纳大量文件。每个存储节点可以有很多数据卷。所以主节点只需要存储关于卷的元数据，这是相当少量的数据，并且通常是稳定的。

实际的文件元数据存储在卷服务器上的每个卷中。由于每个卷服务器只管理自己磁盘上的文件的元数据，每个文件的元数据只有 16 个字节，因此所有文件访问都可以从内存中读取文件元数据，只需要一次磁盘操作即可实际读取文件数据。

## 组件

SeaweedFS 包含 3 个主要的概念组件。主服务和卷服务一起提供了一个分布式对象存储，以及用户可配置的复制和冗余。可选的文件管理器和 S3 服务是对象存储之上的附加层。这些服务中的每一个都可以在各种实际服务器上作为一个实例或单独的实例运行。

### 主服务器 Master service

它代表由 1 个（或 3 个或更多服务器）组成的集群，这些集群拥有整个 SeaweedFS 集群的一致视图，并通过 Raft 协议选举产生的 Leader 将其传达给所有参与的节点。

主服务中的服务器数量必须始终为奇数，以确保可以形成多数共识。最好不要增加此数量，少量稳定的服务器要比大量不稳定的服务器好。典型值为 1 或 3。

通过定期的木筏选举从所有可用的主服务器中任意选择领导者。它分配文件 ID，指定要在其中存储对象的卷，还拥有确定哪些节点是群集的一部分的所有权。

SeaweedFS 中的所有其他卷服务器都将心跳发送给领导者，领导者使用它们来决定将流量路由到何处以及如何处理复制。

如果领导者不可用，则筏共识协议可确保在整个集群的同意下任命新的领导者，并且将现有的不在场的领导者降级，直到能够再次正常运行。

### 卷服务器 Volume service

它将许多对象（文件和文件块）有效地打包到更大的单个卷中，这些卷可以是磁盘上任意大的块。数据的冗余和复制是在卷级别而不是在每个对象级别管理的。

每个卷服务器都通过主机将定期的心跳以及状态和卷信息发送回给领导者。

### Filer service

它通过 HTTP 或 UNIX FUSE 挂载将 SeaweedFS 卷和对象组织到用户可见的路径（如 URL 或文件系统）中。

Filer 提供了一个方便且通用的抽象，可用于为现有应用程序提供正常外观的文件系统或 Web API，以用于向下 / 上载，而无需进行修改。

### S3 service

该可选服务提供了类似于 filer 服务的 AWS 样式 S3 存储桶。它可以单独启动，也可以与文件管理器一起启动。

## 二级

### 三级

```shell

```

```shell

```
